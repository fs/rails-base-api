version: v1.0
name: Rails Base API

agent:
  machine:
    type: e1-standard-8
    os_image: ubuntu1804

auto_cancel:
  queued:
    when: "true"

fail_fast:
  stop:
    when: "true"

blocks:
  - name: Build
    task:
      env_vars:
        - name: BUNDLE_WITHOUT
          value: development staging production
      secrets:
        - name: docker-secrets
      prologue:
        commands:
          # Authenticate with Docker Hub
          - echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin
      jobs:
      - name: Docker build
        commands:
          # Build image
          - checkout
          - docker-compose build
          # Push image to DokerHub
          - docker tag rails_base_api:latest "flatstack/rails_base_api:${SEMAPHORE_WORKFLOW_ID}"
          - docker push "flatstack/rails_base_api:${SEMAPHORE_WORKFLOW_ID}"

  - name: Run & Test Docker image
    task:
      secrets:
        - name: docker-secrets
      prologue:
        commands:
          # Authenticate with Docker Hub
          - echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin
          - checkout
          # Pull image build on previous task
          - docker pull "flatstack/rails_base_api:${SEMAPHORE_WORKFLOW_ID}"
          - docker tag "flatstack/rails_base_api:${SEMAPHORE_WORKFLOW_ID}" rails_base_api:latest
          # Run setup dotenv and run container
          - cp .env.example .env
          - mkdir log tmp
          - chmod 777 log tmp
          - docker-compose up --detach
          # Setup database
          - docker-compose exec app bin/rails db:create db:schema:load
      jobs:
      - name: Check Running Images
        commands:
          - docker ps
      - name: Run RSpec
        commands:
          - docker-compose exec app bin/rspec spec
      - name: Run Quality
        commands:
          - docker-compose exec app bin/quality
